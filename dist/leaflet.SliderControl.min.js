L.Control.SliderControl=L.Control.extend({options:{position:"topright",layer:null,timeAttribute:"time",isEpoch:!1,startTimeIdx:0,timeStrLength:19,maxValue:-1,minValue:0,showAllOnStart:!1,markers:null,range:!1,follow:0,sameDate:!1,alwaysShowDate:!1,rezoom:null,orderMarkers:!0,orderDesc:!1,popupOptions:{},popupContent:"",showAllPopups:!0,showPopups:!0},initialize:function(e){L.Util.setOptions(this,e),this._layer=this.options.layer,L.extend(this,L.Mixin.Events)},onAdd:function(e){this.options.map=e,this.container=L.DomUtil.create("div","",this._container),this.sliderBoxContainer=L.DomUtil.create("div","slider",this.container);var t=L.DomUtil.create("div","",this.sliderBoxContainer);t.id="leaflet-slider",t.style.width="200px",L.DomUtil.create("div","ui-slider-handle",t),this.timestampContainer=L.DomUtil.create("div","slider",this.container),this.timestampContainer.id="slider-timestamp",this.timestampContainer.style.cssText="width:200px; margin-top:3px; background-color:#FFFFFF; text-align:center; border-radius:5px;display:none;",L.DomEvent.disableClickPropagation(this.sliderBoxContainer),this._map.on("mouseup",this.clearTimestamp,this);var r=this.options;if(this.options.markers=[],this._layer){var i=0,o=[];this._layer.eachLayer((function(e){o.push(e)})),r.orderMarkers&&(o=o.sort((function(e,t){var i=null,o=null;if(e.feature&&e.feature.properties&&e.feature.properties[r.timeAttribute]?i=e.feature.properties[r.timeAttribute]:e.options[r.timeAttribute]&&(i=e.options[r.timeAttribute]),t.feature&&t.feature.properties&&t.feature.properties[r.timeAttribute]?o=t.feature.properties[r.timeAttribute]:t.options[r.timeAttribute]&&(o=t.options[r.timeAttribute]),i&&o){if(i<o)return-1;if(i>o)return 1}return 0})),r.orderDesc&&(o=o.reverse()));var a=this;o.forEach((function(e){e instanceof L.LayerGroup?e.getLayers().forEach((function(e){e=a._setPopupProperty(e)})):e=a._setPopupProperty(e),r.markers[i]=e,++i})),r.maxValue=i-1,this.options=r}else console.log("Error: You have to specify a layer via new SliderControl({layer: your_layer});");return this.container},onRemove:function(e){for(i=this.options.minValue;i<=this.options.maxValue;i++)e.removeLayer(this.options.markers[i]);this.container.remove(),e.off("mouseup",this.clearTimestamp,this)},startSlider:function(){var e=this.options,t=this.extractTimestamp,r=e.minValue;e.showAllOnStart&&(r=e.maxValue,e.range?e.values=[e.minValue,e.maxValue]:e.value=e.maxValue);var o=this.timestampContainer,a=this;$(this.sliderBoxContainer).slider({range:e.range,value:e.value,values:e.values,min:e.minValue,max:e.maxValue,sameDate:e.sameDate,step:1,slide:function(r,i){var s=e.map,n=L.featureGroup();if(e.markers[i.value]){void 0!==e.markers[i.value].feature?e.markers[i.value].feature.properties[e.timeAttribute]?e.markers[i.value]&&(o.style.display="block",$(o).html(t(e.markers[i.value].feature.properties[e.timeAttribute],e))):console.error("Time property "+e.timeAttribute+" not found in data"):e.markers[i.value].options[e.timeAttribute]?e.markers[i.value]&&(o.style.display="block",$(o).html(t(e.markers[i.value].options[e.timeAttribute],e))):console.error("Time property "+e.timeAttribute+" not found in data");var p,u=[];for(p=e.minValue;p<=e.maxValue;p++)e.markers[p]&&s.removeLayer(e.markers[p]);if(e.range)for(p=i.values[0];p<=i.values[1];p++)e.markers[p]&&(u.push(e.markers[p]),s.addLayer(e.markers[p]),n.addLayer(e.markers[p]));else if(e.follow>0)for(p=i.value-e.follow+1;p<=i.value;p++)e.markers[p]&&(u.push(e.markers[p]),s.addLayer(e.markers[p]),n.addLayer(e.markers[p]));else if(e.sameDate){var l;for(l=void 0!==e.markers[i.value].feature?e.markers[i.value].feature.properties.time:e.markers[i.value].options.time,p=e.minValue;p<=e.maxValue;p++)e.markers[p].options.time==l&&(u.push(e.markers[p]),s.addLayer(e.markers[p]))}else for(p=e.minValue;p<=i.value;p++)e.markers[p]&&(u.push(e.markers[p]),s.addLayer(e.markers[p]),n.addLayer(e.markers[p]));e.showPopups&&a._openPopups(u),a.fire("rangechanged",{markers:u})}e.rezoom&&s.fitBounds(n.getBounds(),{maxZoom:e.rezoom})}}),e.alwaysShowDate&&(o.style.display="block",void 0!==e.markers[r].feature?e.markers[r].feature.properties[e.timeAttribute]?e.markers[r]&&(o.style.display="block",$(o).html(t(e.markers[r].feature.properties[e.timeAttribute],e))):console.error("Time property "+e.timeAttribute+" not found in data"):e.markers[r].options[e.timeAttribute]?e.markers[r]&&(o.style.display="block",$(o).html(t(e.markers[r].options[e.timeAttribute],e))):console.error("Time property "+e.timeAttribute+" not found in data"));var s=[];for(i=e.minValue;i<=r;i++)s.push(e.markers[i]),e.map.addLayer(e.markers[i]);e.showPopups&&this._openPopups(s),this.fire("rangechanged",{markers:s})},clearTimestamp:function(){this.options.alwaysShowDate||(this.timestampContainer.innerHTML="",this.timestampContainer.style.display="none")},extractTimestamp:function(e,t){return t.isEpoch&&(e=new Date(parseInt(e)).toString()),(e=new Date(e).toLocaleString()).substr(t.startTimeIdx,t.startTimeIdx+t.timeStrLength)},setPosition:function(e){var t=this._map;return t&&t.removeControl(this),this.options.position=e,t&&t.addControl(this),this.startSlider(),this},_setPopupProperty:function(e){return e._popup&&(e._orgpopup=e._popup),e},_openPopups:function(e){var t=this.options,r=this;e.forEach((function(e){if(e instanceof L.LayerGroup)r._openPopups(e.getLayers());else if(e._orgpopup)e._popup=e._orgpopup,t.showAllPopups&&(e._popup.options.autoClose=!1),e.openPopup();else if(t.popupContent){var i=t.popupOptions;t.showAllPopups&&(i.autoClose=!1),e.bindPopup(t.popupContent,i).openPopup()}}))}}),L.control.sliderControl=function(e){return new L.Control.SliderControl(e)};
